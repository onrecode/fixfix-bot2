name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/fixfix-bot2

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Run tests
        run: |
          echo " Running tests..."
          python test_github_actions.py
          echo "âœ… Tests completed successfully!"

  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð´ÐµÐ¿Ð»Ð¾Ð¹
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "ðŸš€ Starting deployment..."
            echo "ðŸ“… Deployment time: $(date)"
            echo "ðŸ§ System info: $(uname -a)"
            echo "ðŸ³ Docker version: $(docker --version)"
            echo "ðŸ“¦ Docker Compose version: $(docker-compose --version)"
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
            mkdir -p /opt/fixfix-bot
            cd /opt/fixfix-bot
            echo "ðŸ“ Working directory: $(pwd)"
            
            # Check existing files
            echo "ðŸ“‹ Existing files:"
            ls -la || echo "Directory is empty"
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
            echo "ðŸ“ Creating .env file..."
            cat > .env << 'ENV_EOF'
            # Telegram Bot
            TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
            REQUESTS_GROUP_ID=${{ secrets.REQUESTS_GROUP_ID }}
            ADMIN_IDS=${{ secrets.ADMIN_IDS }}
            
            # Database
            DB_HOST=postgres
            DB_PORT=5432
            DB_NAME=fixfix_bot
            DB_USER=postgres
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            # API
            API_HOST=0.0.0.0
            API_PORT=8000
            API_DEBUG=false
            ENV_EOF
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ docker-compose.yml
            echo "ðŸ“ Creating docker-compose.yml..."
            cat > docker-compose.yml << 'COMPOSE_EOF'
            version: '3.8'
            
            services:
              # PostgreSQL Ð±Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
              postgres:
                image: postgres:15-alpine
                container_name: fixfix_postgres
                environment:
                  POSTGRES_DB: ${DB_NAME:-fixfix_bot}
                  POSTGRES_USER: ${DB_USER:-postgres}
                  POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                ports:
                  - "127.0.0.1:5432:5432"
                networks:
                  - fixfix_network
                restart: unless-stopped
            
              # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (API)
              app:
                image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                container_name: fixfix_app
                environment:
                  - DB_HOST=postgres
                  - DB_PORT=5432
                  - DB_NAME=${DB_NAME:-fixfix_bot}
                  - DB_USER=${DB_USER:-postgres}
                  - DB_PASSWORD=${DB_PASSWORD:-password}
                  - DEBUG=${DEBUG:-false}
                ports:
                  - "8000:8000"
                depends_on:
                  - postgres
                networks:
                  - fixfix_network
                volumes:
                  - ./logs:/app/logs
                restart: unless-stopped
                command: ["python", "-m", "app.main"]

              # Telegram Bot (Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ)
              bot:
                image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                container_name: fixfix_bot
                environment:
                  - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
                  - REQUESTS_GROUP_ID=${REQUESTS_GROUP_ID:-1004796553922}
                  - ADMIN_IDS=${ADMIN_IDS:-}
                  - API_BASE_URL=http://app:8000/api/v1
                depends_on:
                  - app
                networks:
                  - fixfix_network
                volumes:
                  - ./logs:/app/logs
                restart: unless-stopped
                command: ["python", "main.py"]
            
            volumes:
              postgres_data:
            
            networks:
              fixfix_network:
                driver: bridge
            COMPOSE_EOF
            
            # Pull latest image explicitly (Ð´Ð»Ñ ÐºÐµÑˆÐ°)
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð¾ÑÐ¸Ñ€Ð¾Ñ‚ÐµÐ²ÑˆÐ¸Ðµ)
            docker-compose down --remove-orphans || true

            # ÐÐ° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ Ñ‡Ð¸ÑÑ‚Ð¸Ð¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ fixfix_, ÐµÑÐ»Ð¸ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ
            docker ps -aq --filter "name=fixfix_" | xargs -r docker rm -f || true

            # Ð¢ÑÐ½ÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
            docker-compose pull || true

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¾ÑÐ¸Ñ€Ð¾Ñ‚ÐµÐ²ÑˆÐ¸Ñ…
            docker-compose up -d --force-recreate --remove-orphans
            
            echo "âœ… Deployment completed successfully!"
            
            # Show running containers
            docker ps
            
            # Show logs for debugging
            echo "ðŸ“‹ Checking container logs..."
            echo "=== PostgreSQL logs ==="
            docker logs fixfix_postgres --tail=10 || echo "PostgreSQL container not found"
            
            echo "=== App logs ==="
            docker logs fixfix_app --tail=20 || echo "App container not found"
            
            echo "=== Bot logs ==="
            docker logs fixfix_bot --tail=20 || echo "Bot container not found"
            
            echo "=== Docker Compose status ==="
            docker-compose ps
            
            echo "=== Environment check ==="
            echo "DB_HOST: $DB_HOST"
            echo "DB_PORT: $DB_PORT"
            echo "TELEGRAM_TOKEN: ${TELEGRAM_TOKEN:0:10}..." # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ñ‚Ð¾ÐºÐµÐ½Ð°
            
            echo "=== File check ==="
            ls -la
            echo "=== .env content (without secrets) ==="
            cat .env | grep -v TOKEN | grep -v PASSWORD
            
            echo "=== Docker Compose config ==="
            docker-compose config
            
            echo "âœ… Deployment completed successfully!"